# Правила проекта: Iterative Expert-Guided Fine-Tuning

## Язык и версия
- Используйте Python 3.10 или выше
- Всегда используйте type hints для всех функций, методов и переменных
- Используйте `from __future__ import annotations` в начале файлов для отложенных аннотаций

## Библиотеки и фреймворки
- Используйте PyTorch для всех операций с нейронными сетями
- Используйте HuggingFace Transformers для моделей и токенизаторов
- Предполагайте выполнение только на CPU (без CUDA-специфичного кода)
- Не используйте `.cuda()`, `.to('cuda')` или другие GPU-специфичные вызовы
- Используйте `.to(device)` с `device = torch.device('cpu')` если необходимо

## Архитектура проекта

### Модульная структура
Проект должен быть организован следующим образом:

```
src/
  config.py          # Dataclasses для всех конфигураций
  data.py            # Загрузка датасетов, разбиение на train/val/test, DataLoaders
  models/            # Обертки для student и teacher моделей
    __init__.py
    student.py
    teacher.py
  training/          # Циклы обучения
    __init__.py
    trainer.py
    distillation.py
  metrics.py         # Общие метрики и функции оценки
  utils.py           # Общие утилиты и вспомогательные функции

scripts/             # CLI entrypoints для запуска экспериментов
  train.py
  evaluate.py
  distill.py
```

### Правила организации кода

1. **Конфигурации (`src/config.py`)**:
   - Все гиперпараметры должны быть в dataclasses
   - Используйте `@dataclass` с type hints
   - Группируйте связанные параметры в отдельные dataclasses
   - Никаких hardcoded значений в коде обучения

2. **Данные (`src/data.py`)**:
   - Функции для загрузки датасетов
   - Функции для разбиения на train/val/test
   - Создание DataLoaders с настраиваемыми параметрами
   - Все параметры (batch_size, num_workers и т.д.) должны приходить из config

3. **Модели (`src/models/`)**:
   - Отдельные модули для student и teacher моделей
   - Обертки вокруг HuggingFace моделей
   - Четкое разделение ответственности

4. **Обучение (`src/training/`)**:
   - Основной цикл обучения в `trainer.py`
   - Логика дистилляции в `distillation.py`
   - Все гиперпараметры берутся из config объектов

5. **Метрики и утилиты**:
   - `src/metrics.py`: функции для вычисления метрик
   - `src/utils.py`: общие вспомогательные функции

6. **Скрипты (`scripts/`)**:
   - CLI entrypoints для запуска экспериментов
   - Парсинг аргументов командной строки
   - Создание config объектов из аргументов
   - Запуск обучения/оценки

## Стиль кода

### Функции
- Предпочитайте маленькие, сфокусированные функции
- Каждая функция должна иметь docstring (Google style или NumPy style)
- Используйте type hints для всех параметров и возвращаемых значений
- Избегайте функций длиннее 50-80 строк

### Конфигурации
- Все экспериментальные выборы (название датасета, имена моделей, гиперпараметры) должны быть частью config объектов
- Не используйте разбросанные литералы в коде
- Используйте dataclasses с валидацией при необходимости

### Импорты
- Группируйте импорты: стандартная библиотека, сторонние библиотеки, локальные импорты
- Используйте абсолютные импорты для локальных модулей
- Сортируйте импорты в алфавитном порядке внутри каждой группы

### Обработка ошибок
- Используйте конкретные исключения
- Добавляйте информативные сообщения об ошибках
- Валидируйте входные данные в начале функций

## Примеры хороших практик

### Пример dataclass конфигурации:
```python
from dataclasses import dataclass
from typing import Optional

@dataclass
class TrainingConfig:
    batch_size: int = 32
    learning_rate: float = 2e-5
    num_epochs: int = 3
    warmup_steps: int = 100
    max_grad_norm: float = 1.0
```

### Пример функции с type hints и docstring:
```python
def load_dataset(
    dataset_name: str,
    split: str = "train"
) -> Dataset:
    """
    Загружает датасет из HuggingFace datasets.
    
    Args:
        dataset_name: Название датасета в HuggingFace Hub
        split: Разбиение датасета (train, validation, test)
    
    Returns:
        Загруженный датасет
    """
    # Implementation
    pass
```

## Запрещенные практики

- ❌ Hardcoded гиперпараметры в циклах обучения
- ❌ CUDA-специфичный код (`.cuda()`, `.to('cuda')`)
- ❌ Функции без type hints
- ❌ Модули без docstrings
- ❌ Разбросанные литералы вместо config объектов
- ❌ Монолитные функции длиннее 100 строк
- ❌ Относительные импорты для локальных модулей

## Приоритеты

1. **Модульность**: Код должен быть легко расширяемым и тестируемым
2. **Конфигурируемость**: Все параметры через config объекты
3. **Читаемость**: Четкие имена, docstrings, type hints
4. **CPU-совместимость**: Код должен работать на CPU без модификаций

